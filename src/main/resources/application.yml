server:
  port: 8082

spring:
  application:
    name: demo
  rabbitmq:
    host: ${SPRING_RABBITMQ_HOST:localhost}
    port: ${SPRING_RABBITMQ_PORT:5672}
    username: ${SPRING_RABBITMQ_USERNAME:guest}
    password: ${SPRING_RABBITMQ_PASSWORD:guest}
    cache:
      channel:
        size: 50   # increase channel cache for higher throughput

  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/postgres}
    driver-class-name: org.postgresql.Driver
    username: ${SPRING_DATASOURCE_USERNAME:postgres}
    password: ${SPRING_DATASOURCE_PASSWORD:postgres}
    hikari:
      maximum-pool-size: ${SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE:10}
      minimum-idle: ${SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE:2}
      connection-timeout: ${SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT:30000}
      idle-timeout: ${SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT:600000}
      max-lifetime: ${SPRING_DATASOURCE_HIKARI_MAX_LIFETIME:1800000}

  modulith:
    events:
      externalization:
        enabled: ${SPRING_MODULITH_EVENTS_EXTERNALIZATION_ENABLED:true}
      jdbc:
        schema-initialization:
          enabled: true
      # PostgreSQL: enable restart republish for reliability (events survive restarts)
      republish-outstanding-events-on-restart: true
      # UPDATE mode keeps event history for debugging and audit purposes
      completion-mode: UPDATE
      # Time to live for completed events (7 days = 604800 seconds)
      # After this period, completed events should be cleaned up via a scheduled job
      time-to-live: ${SPRING_MODULITH_EVENTS_TIME_TO_LIVE:7d}

logging:
  level:
    org.springframework.modulith: INFO
    org.springframework.amqp: INFO

management:
  endpoint:
    health:
      show-details: always
      show-components: always
  endpoints:
    web:
      exposure:
        include: health,info

app:
  amqp:
    new-orders:
      # Control whether to bind queue 'new-orders' to exchange 'BookStoreExchange' with routing key 'orders.new'.
      # Default false to avoid unintended feedback loops with @Externalized(OrderCreatedEvent).
      bind: true
      # Max processing attempts before rejecting to DLQ. Can be overridden via
      # env var SPRING_APPLICATION_JSON or CLI: --app.amqp.new-orders.retry-max-attempts=5
      retry-max-attempts: 3
